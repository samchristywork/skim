<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skim</title>
    <style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f4f4f4;
  color: #333;
}

.content {
  max-width: 800px;
  margin: auto;
  background: white;
  padding: 20px;
  padding-top: 50px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  position: relative;
}

p {
  line-height: 1.6;
  margin-bottom: 15px;
  margin-top: 0;
}

.highlight {
  background-color: yellow;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.time {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 0.8em;
  color: #777;
}

#playPauseButton {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 5px 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
}

#textInput {
  width: 100%;
  height: 100px;
  margin-bottom: 10px;
  padding: 5px;
  box-sizing: border-box;
}

#loadButton {
  background-color: #008CBA;
  color: white;
  padding: 5px 10px;
  border: none;
  cursor: pointer;
}

#speedControl {
  position: absolute;
  top: 10px;
  left: 100px;
}

#speedLabel {
  margin-right: 5px;
  color: #555;
}
    </style>
  </head>
  <body>
    <div class="content">
      <textarea id="textInput" placeholder="Enter your text here..."></textarea>
      <button id="loadButton">Load Text</button>
      <button id="playPauseButton">Play</button>
      <div id="speedControl">
        <label id="speedLabel" for="speed">Speed:</label>
        <input type="number" id="speed" value="20" min="1" max="100" step="1">
      </div>
      <div class="time"><span id="time"></span></div>
    </div>
  </body>
  <script>
    let isPaused = true;
    let currentTimeout;

    let elementIndex = 0;
    let charIndex = 0;

    let elements = [];
    let totalChars = 0;

    let speed = 20;

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function processTextToElements(text) {
      const contentDiv = document.querySelector(".content");
      while (contentDiv.firstChild && contentDiv.firstChild.id !== 'playPauseButton' && contentDiv.firstChild.id !== 'time' && contentDiv.firstChild.id !== 'speedControl') {
        contentDiv.removeChild(contentDiv.firstChild);
      }

      elements = [];
      totalChars = 0;

      text.split("\n").forEach((line) => {
        line = line.trim();
        if (line === "") return;
        let p = document.createElement("p");
        p.textContent = line;
        elements.push(p);
        contentDiv.appendChild(p);
        totalChars += line.length;

        p.addEventListener('click', () => {
          elements.forEach(el => el.innerHTML = el.textContent);
          charIndex = 0;
          elementIndex = elements.indexOf(p);
          isPaused = false;
        });
      });

      return { elements, totalChars };
    }

    function setTotalTime(totalChars, timePerChar) {
      let timeElement = document.getElementById('time');
      const ms = totalChars * timePerChar;
      const s = Math.ceil(ms / 1000);
      const t = s > 60 ? `${Math.floor(s / 60)}m ${s % 60}s` : `${s}s`;
      timeElement.textContent = t;
    }

    async function highlightCharacter(child, textContent, i, timePerChar) {
      if (isPaused) {
        await waitForResume();
      }

      let before = textContent.slice(0, i);
      let char = textContent[i];
      let after = textContent.slice(i + 1);
      let highlightedHTML = `${before}<span class="highlight">${char}</span>${after}`;
      child.innerHTML = highlightedHTML;

      scrollToHighlightedCharacter(child);

      await sleep(timePerChar);
    }

    function scrollToHighlightedCharacter(child) {
      const highlightedSpan = child.querySelector('.highlight');
      if (highlightedSpan) {
        const elementTop = highlightedSpan.offsetTop;
        const elementHeight = highlightedSpan.offsetHeight;
        const screenHeight = window.innerHeight;
        const scrollTo = elementTop - (screenHeight / 3) + (elementHeight / 2);

        window.scrollTo({
          top: scrollTo,
          behavior: 'smooth'
        });
      }
    }

    async function waitForResume() {
      return new Promise(resolve => {
        const checkPause = () => {
          if (!isPaused) {
            resolve();
          } else {
            currentTimeout = setTimeout(checkPause, 100);
          }
        };
        checkPause();
      });
    }

    async function highlightText() {
      setTotalTime(totalChars, speed);

      try {
        while (elementIndex < elements.length) {
          const child = elements[elementIndex];
          const textContent = child.textContent;

          await highlightCharacter(child, textContent, charIndex, speed);
          charIndex++;

          if (charIndex >= textContent.length) {
            child.innerHTML = textContent;
            elementIndex++;
            charIndex = 0;
          }
        }
      } catch (error) {
        console.error("Error processing content:", error);
      }
    }

    const playPauseButton = document.getElementById('playPauseButton');
    const loadButton = document.getElementById('loadButton');
    const textInput = document.getElementById('textInput');
    const speedInput = document.getElementById('speed');

    playPauseButton.addEventListener('click', () => {
      isPaused = !isPaused;
      playPauseButton.textContent = isPaused ? 'Play' : 'Pause';
    });

    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        event.preventDefault();
        isPaused = !isPaused;
        playPauseButton.textContent = isPaused ? 'Play' : 'Pause';
      } else if (event.code === 'ArrowRight' || event.code === 'KeyN') {
        if (elementIndex < elements.length - 1) {
          elements[elementIndex].innerHTML = elements[elementIndex].textContent;
          elementIndex++;
          charIndex = 0;
          isPaused = false;
          playPauseButton.textContent = 'Pause';
        }
      } else if (event.code === 'ArrowLeft' || event.code === 'KeyP') {
        if (elementIndex > 0) {
          elements[elementIndex].innerHTML = elements[elementIndex].textContent;
          elementIndex--;
          charIndex = 0;
          isPaused = false;
          playPauseButton.textContent = 'Pause';
        }
      } else if (event.code === 'ArrowUp') {
        speed = Math.max(1, speed - 1);
        speedInput.value = speed;
        setTotalTime(totalChars, speed);
      } else if (event.code === 'ArrowDown') {
        speed = Math.min(100, speed + 1);
        speedInput.value = speed;
        setTotalTime(totalChars, speed);
      } else if (event.code === 'KeyR') {
        elements.forEach(el => el.innerHTML = el.textContent);
        elementIndex = 0;
        charIndex = 0;
        isPaused = false;
        playPauseButton.textContent = 'Pause';
      } else {
        console.log('Other key pressed:', event.code);
      }
    });

    loadButton.addEventListener('click', async () => {
      const text = textInput.value;
      const result = await processTextToElements(text);
      elements = result.elements;
      totalChars = result.totalChars;
      elementIndex = 0;
      charIndex = 0;
      highlightText();
    });

    speedInput.addEventListener('change', () => {
      speed = parseInt(speedInput.value, 10);
      if (isNaN(speed) || speed < 1) {
        speed = 1;
        speedInput.value = 1;
      }
      setTotalTime(totalChars, speed);
    });
  </script>
</html>
