<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO</title>
    <style>
    </style>
  </head>
  <body>
    <div class="content">
      <button id="playPauseButton">Pause</button>
      <div class="time"><span id="time"></span></div>
    </div>
  </body>
  <script>
    let isPaused = false;
    let currentTimeout;

    let elementIndex = 0;
    let charIndex = 0;

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function fetchAndProcessContent() {
      try {
        const response = await fetch("content");
        const text = await response.text();
        return processTextToElements(text);
      } catch (error) {
        console.error("Error fetching content:", error);
        return [];
      }
    }

    function processTextToElements(text) {
      let elements = [];
      let totalChars = 0;
      let content = document.querySelector(".content");

      text.split("\n").forEach((line) => {
        line = line.trim();
        if (line === "") return;
        let p = document.createElement("p");
        p.textContent = line;
        elements.push(p);
        content.appendChild(p);
        totalChars += line.length;

        p.addEventListener('click', () => {
          charIndex = 0;
          elementIndex = elements.indexOf(p);
          isPaused = false;
        });
      });

      return { elements, totalChars };
    }

    function setTotalTime(totalChars, timePerChar) {
      let timeElement = document.getElementById('time');
      const ms = totalChars * timePerChar;
      const s = Math.ceil(ms / 1000);
      const t = s > 60 ? `${Math.floor(s / 60)}m ${s % 60}s` : `${s}s`;
      timeElement.textContent = t;
    }

    async function highlightCharacter(child, textContent, i, timePerChar) {
      if (isPaused) {
        await waitForResume();
      }

      let before = textContent.slice(0, i);
      let char = textContent[i];
      let after = textContent.slice(i + 1);
      let highlightedHTML = `${before}<span class="highlight">${char}</span>${after}`;
      child.innerHTML = highlightedHTML;

      scrollToHighlightedCharacter(child);

      await sleep(timePerChar);
    }

    function scrollToHighlightedCharacter(child) {
      const highlightedSpan = child.querySelector('.highlight');
      if (highlightedSpan) {
        const elementTop = highlightedSpan.offsetTop;
        const elementHeight = highlightedSpan.offsetHeight;
        const screenHeight = window.innerHeight;
        const scrollTo = elementTop - (screenHeight / 3) + (elementHeight / 2);

        window.scrollTo({
          top: scrollTo,
          behavior: 'smooth'
        });
      }
    }

    async function waitForResume() {
      return new Promise(resolve => {
        const checkPause = () => {
          if (!isPaused) {
            resolve();
          } else {
            currentTimeout = setTimeout(checkPause, 100);
          }
        };
        checkPause();
      });
    }

    async function highlightText() {
      const timePerChar = 20;

      try {
        const { elements, totalChars } = await fetchAndProcessContent();
        setTotalTime(totalChars, timePerChar);

        while (elementIndex < elements.length) {
          const child = elements[elementIndex];
          const textContent = child.textContent;

          await highlightCharacter(child, textContent, charIndex, timePerChar);
          charIndex++;

          if (charIndex >= textContent.length) {
            child.innerHTML = textContent;
            elementIndex++;
            charIndex = 0;
          }
        }
      } catch (error) {
        console.error("Error processing content:", error);
      }
    }

    const playPauseButton = document.getElementById('playPauseButton');

    playPauseButton.addEventListener('click', () => {
      isPaused = !isPaused;
      playPauseButton.textContent = isPaused ? 'Play' : 'Pause';
    });

    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        event.preventDefault();
        isPaused = !isPaused;
        playPauseButton.textContent = isPaused ? 'Play' : 'Pause';
      }
    });

    highlightText();
  </script>
</html>
